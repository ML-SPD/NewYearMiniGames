<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å°¾ç‰™åˆ‡æ°´æœå¤§è³½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxTaWg2WJ1_01w4sOe1FKXXx6idNfOWVc",
            authDomain: "ml-app-test-website.firebaseapp.com",
            projectId: "ml-app-test-website",
            storageBucket: "ml-app-test-website.firebasestorage.app",
            messagingSenderId: "24622595377",
            appId: "1:24622595377:web:eef25cf878daf5c1af0410"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ç®¡ç†è€…é‚è¼¯ ---
        const ADMIN_PASSWORD = "8888"; // ä½ å¯ä»¥ä¿®æ”¹ä½ çš„å¾Œå°å¯†ç¢¼
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminMode = urlParams.get('admin') === 'true';

        window.onload = () => {
            // åˆå§‹åŒ–æˆªæ­¢æ™‚é–“ (é è¨­ 19:30)
            if(!localStorage.getItem('gameDeadline')) {
                localStorage.setItem('gameDeadline', "2026-01-05T19:30");
            }
            updateDeadlineDisplay();

            if (isAdminMode) {
                const pass = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
                if (pass === ADMIN_PASSWORD) {
                    document.getElementById('login-menu').style.display = 'none';
                    document.getElementById('admin-board').classList.remove('hidden');
                    startLeaderboardStream();
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                    window.location.href = window.location.pathname;
                }
            }
        };

        function updateDeadlineDisplay() {
            const d = localStorage.getItem('gameDeadline');
            const display = document.getElementById('current-deadline-text');
            if(display) display.innerText = d.replace("T", " ");
        }

        // ä¿®æ”¹æ™‚é–“çš„å‡½æ•¸
        window.changeDeadline = () => {
            const newTime = document.getElementById('deadline-input').value;
            if(newTime) {
                localStorage.setItem('gameDeadline', newTime);
                updateDeadlineDisplay();
                alert("æˆªæ­¢æ™‚é–“å·²æ›´æ–°ç‚º: " + newTime);
            }
        };

        window.uploadScore = async (uid, name, avatar, score) => {
            const deadlineStr = localStorage.getItem('gameDeadline');
            if (new Date() > new Date(deadlineStr)) {
                alert("æ´»å‹•å·²æˆªæ­¢ï¼Œåˆ†æ•¸ä¸ç´å…¥æ’è¡Œæ¦œå–”ï¼");
                return;
            }
            try {
                await addDoc(collection(db, "scores"), {
                    userId: uid, playerName: name, avatar: avatar, score: score, createdAt: serverTimestamp()
                });
            } catch (e) { console.error("Firebase Error: ", e); }
        };

        function startLeaderboardStream() {
            const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(10));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('admin-list');
                listEl.innerHTML = "";
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    listEl.innerHTML += `
                        <div class="flex items-center justify-between bg-gray-800 p-4 rounded-xl border-l-4 ${index < 3 ? 'border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.3)]' : 'border-blue-500'}">
                            <div class="flex items-center space-x-4">
                                <span class="text-2xl font-black w-8">${index + 1}</span>
                                <span class="text-4xl">${data.avatar}</span>
                                <div><p class="font-bold text-xl">${data.playerName}</p><p class="text-xs text-gray-500">ID: ${data.userId}</p></div>
                            </div>
                            <span class="text-4xl font-black text-yellow-400">${data.score}</span>
                        </div>`;
                });
            });
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; touch-action: none; font-family: 'Microsoft JhengHei', sans-serif; }
        canvas { display: block; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; overflow-y: auto; padding: 20px; }
        .avatar-option { width: 60px; height: 60px; border: 3px solid transparent; border-radius: 50%; cursor: pointer; transition: 0.2s; font-size: 35px; display: flex; align-items: center; justify-content: center; background: #333; }
        .avatar-selected { border-color: #fbbf24; transform: scale(1.1); background: #444; }
        #screenshot-area { background: linear-gradient(145deg, #1e3a8a, #1e40af); padding: 30px; border-radius: 20px; text-align: center; color: white; border: 4px solid #fbbf24; width: 320px; }
    </style>
</head>
<body>

    <div id="login-menu" class="overlay text-white">
        <h1 class="text-3xl font-black text-yellow-500 mb-6 italic">2026 å°¾ç‰™åˆ‡æ°´æœå¤§è³½</h1>
        <div class="w-full max-w-xs space-y-4 text-black">
            <input type="text" id="userId" placeholder="å“¡å·¥å¸³è™Ÿ" class="w-full p-3 rounded-lg text-center font-bold">
            <input type="text" id="pName" placeholder="ä½ çš„æš±ç¨±" class="w-full p-3 rounded-lg text-center font-bold">
            <div class="grid grid-cols-4 gap-2 py-2" id="avatar-list">
                <div class="avatar-option" onclick="setAvatar('ğŸ‘¨â€ğŸ’¼', this)">ğŸ‘¨â€ğŸ’¼</div>
                <div class="avatar-option" onclick="setAvatar('ğŸ‘©â€ğŸ’¼', this)">ğŸ‘©â€ğŸ’¼</div>
                <div class="avatar-option" onclick="setAvatar('ğŸ±', this)">ğŸ±</div>
                <div class="avatar-option" onclick="setAvatar('ğŸ¦', this)">ğŸ¦</div>
                <div class="avatar-option" onclick="setAvatar('ğŸ¦Š', this)">ğŸ¦Š</div>
                <div class="avatar-option" onclick="setAvatar('ğŸ¶', this)">ğŸ¶</div>
                <div class="avatar-option" onclick="setAvatar('ğŸµ', this)">ğŸµ</div>
                <div class="avatar-option" onclick="setAvatar('ğŸ¼', this)">ğŸ¼</div>
            </div>
        </div>
        <button onclick="bootGame()" class="mt-8 bg-gradient-to-r from-yellow-600 to-orange-600 px-16 py-4 rounded-full text-xl font-bold shadow-xl active:scale-95 transition">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="admin-board" class="overlay text-white hidden">
        <div class="absolute top-10 right-10 bg-gray-900 p-4 rounded-xl border border-gray-700 text-sm">
            <p class="mb-2 text-yellow-500 font-bold">å¾Œå°ç®¡ç†</p>
            <input type="datetime-local" id="deadline-input" class="text-black p-1 rounded mb-2 w-full">
            <button onclick="changeDeadline()" class="bg-blue-600 px-4 py-1 rounded w-full">æ›´æ–°æˆªæ­¢æ™‚é–“</button>
        </div>
        
        <h1 class="text-5xl font-black text-yellow-500 mb-8 italic drop-shadow-lg">LIVE æ’è¡Œæ¦œ</h1>
        <div id="admin-list" class="w-full max-w-2xl space-y-3"></div>
        <p class="mt-8 text-xl">ç›®å‰æˆªæ­¢æ™‚é–“ï¼š<span id="current-deadline-text" class="text-red-500 font-bold">--</span></p>
    </div>

    <div id="result-screen" class="overlay text-white hidden">
        <div id="screenshot-area">
            <div id="res-avatar" class="text-7xl mb-2">ğŸ¦</div>
            <h2 id="res-name" class="text-2xl font-bold">æš±ç¨±</h2>
            <div class="my-6">
                <p class="text-sm opacity-70">SCORE</p>
                <p id="res-score" class="text-7xl font-black text-yellow-400">0</p>
            </div>
            <p id="res-time" class="text-xs opacity-50"></p>
        </div>
        <button onclick="downloadImg()" class="mt-6 bg-green-600 px-10 py-3 rounded-lg font-bold flex items-center space-x-2">
            <span>â¬‡ ä¸‹è¼‰æˆç¸¾å–® (æ‰‹æ©Ÿæˆªåœ–ç”¨)</span>
        </button>
        <button onclick="location.reload()" class="mt-4 text-gray-400 underline">å›ä¸»é¸å–®</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        let selectedAvatar = "ğŸ‘¨â€ğŸ’¼";
        let score = 0, lives = 3, gameActive = false, fruits = [];
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function setAvatar(emoji, el) {
            document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('avatar-selected'));
            el.classList.add('avatar-selected');
            selectedAvatar = emoji;
        }

        function bootGame() {
            if(!document.getElementById('userId').value || !document.getElementById('pName').value) return alert("è«‹å¡«å¯«å¸³è™Ÿèˆ‡æš±ç¨±");
            document.getElementById('login-menu').style.display = 'none';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gameActive = true;
            loop();
        }

        class Fruit {
            constructor() {
                this.x = Math.random() * (canvas.width - 60) + 30;
                this.y = canvas.height + 20;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = -(Math.random() * 5 + 14);
                this.emoji = ['ğŸ', 'ğŸ‰', 'ğŸ', 'ğŸ¥', 'ğŸŠ', 'ğŸ‡'][Math.floor(Math.random()*6)];
                this.sliced = false;
            }
            update() { this.vy += 0.25; this.x += this.vx; this.y += this.vy; }
            draw() { ctx.font="50px Arial"; ctx.fillText(this.emoji, this.x-25, this.y+20); }
        }

        function loop() {
            if (!gameActive) return;
            ctx.fillStyle = 'rgba(26,26,26,0.6)';
            ctx.fillRect(0,0,canvas.width, canvas.height);
            if(Math.random() < 0.04) fruits.push(new Fruit());
            fruits.forEach((f, i) => {
                f.update(); f.draw();
                if(f.y > canvas.height + 50) { if(!f.sliced) lives--; fruits.splice(i,1); }
            });
            if(lives <= 0) finish();
            else requestAnimationFrame(loop);
        }

        // æ‰‹æŒ‡/æ»‘é¼ åˆ‡å‰²é‚è¼¯
        const handleCut = (e) => {
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            fruits.forEach(f => {
                if(!f.sliced && Math.hypot(f.x-x, f.y-y) < 50) { f.sliced = true; score += 10; }
            });
        };
        window.addEventListener('touchmove', (e) => { e.preventDefault(); handleCut(e); }, {passive: false});
        window.addEventListener('mousemove', (e) => { if(e.buttons === 1) handleCut(e); });

        async function finish() {
            gameActive = false;
            const uid = document.getElementById('userId').value;
            const name = document.getElementById('pName').value;
            document.getElementById('res-avatar').innerText = selectedAvatar;
            document.getElementById('res-name').innerText = name;
            document.getElementById('res-score').innerText = score;
            document.getElementById('res-time').innerText = "DATE: " + new Date().toLocaleString();
            document.getElementById('result-screen').classList.remove('hidden');
            if (window.uploadScore) await window.uploadScore(uid, name, selectedAvatar, score);
        }

        function downloadImg() {
            html2canvas(document.querySelector("#screenshot-area")).then(c => {
                const a = document.createElement('a');
                a.download = `score_${score}.png`;
                a.href = c.toDataURL();
                a.click();
            });
        }
    </script>
</body>
</html>