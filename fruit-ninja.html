<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Meiloon åˆ‡æ°´æœå¤§è³½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, doc, getDocs, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxTaWg2WJ1_01w4sOe1FKXXx6idNfOWVc",
            authDomain: "ml-app-test-website.firebaseapp.com",
            projectId: "ml-app-test-website",
            storageBucket: "ml-app-test-website.firebasestorage.app",
            messagingSenderId: "24622595377",
            appId: "1:24622595377:web:eef25cf878daf5c1af0410"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch;
        window.setDoc = setDoc;

        // --- å…¨åŸŸè®Šæ•¸ ---
        window.gameDeadline = "2026-02-06T19:30"; // é è¨­å€¼
        window.maxLives = 6;
        window.gameDuration = 60;

        window.onload = () => {
            if (navigator.userAgent.includes("Line")) {
                document.getElementById('line-warning').classList.remove('hidden');
            }

            const savedId = localStorage.getItem('meiloon_userid');
            const savedName = localStorage.getItem('meiloon_pname');
            if(savedId) document.getElementById('userId').value = savedId;
            if(savedName) document.getElementById('pName').value = savedName;

            initAvatars();

            // Listen for Fruit Ninja Config
            onSnapshot(doc(db, "config", "fruitSettings"), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.gameDeadline) {
                        window.gameDeadline = data.gameDeadline;
                        startDeadlineCountdown(window.gameDeadline);
                    }
                    if(data.maxLives) window.maxLives = data.maxLives;
                    if(data.gameDuration) window.gameDuration = data.gameDuration;
                }
            });

            if (isAdminMode) {
                // Show secure login modal instead of prompt
                document.getElementById('login-menu').style.display = 'none';
                document.getElementById('admin-login-modal').classList.remove('hidden');
            }
        };

        // QR Code Logic
        const GAME_URL = "https://tailgame.netlify.app";
        
        window.resizeQR = (scale) => {
            const container = document.getElementById('qr-container');
            container.style.transform = `scale(${scale})`;
        };

        window.checkAdminLogin = () => {
            const input = document.getElementById('admin-pass-input');
            if (input.value === ADMIN_PASSWORD) {
                document.getElementById('admin-login-modal').classList.add('hidden');
                document.getElementById('admin-board').classList.remove('hidden');
                startLeaderboardStream();
                
                // Generate QRs
                new QRCode(document.getElementById("qrcode-full"), { text: GAME_URL, width: 400, height: 400 });
                new QRCode(document.getElementById("qrcode-small"), { text: GAME_URL, width: 64, height: 64 });
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                input.value = "";
            }
        };

        const ADMIN_PASSWORD = "8888"; 
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminMode = urlParams.get('admin') === 'true';

        let deadlineInterval;
        let currentTrackingDeadline = null;

        function startDeadlineCountdown(deadlineStr) {
            // Optimization: Prevent resetting timer if deadline hasn't changed
            if (currentTrackingDeadline === deadlineStr && deadlineInterval) return;
            currentTrackingDeadline = deadlineStr;

            if(deadlineInterval) clearInterval(deadlineInterval);
            const target = new Date(deadlineStr).getTime();

            const tick = () => {
                const now = new Date().getTime();
                const diff = target - now;
                const el = document.getElementById('current-deadline-text');
                if(!el) return;

                if(diff <= 0) {
                    el.innerText = "TIME UP";
                    el.className = "text-red-500 font-black text-2xl animate-pulse";
                    if(deadlineInterval) clearInterval(deadlineInterval);
                } else {
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    // Optimization: Pad seconds and use monospace font
                    el.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                    el.className = "text-yellow-400 font-mono text-2xl font-black";
                }
            };
            tick(); 
            deadlineInterval = setInterval(tick, 1000);
        }
        
        // Removed updateDeadlineDisplay as it is replaced by startDeadlineCountdown

        window.changeDeadline = async () => {
            const newTime = document.getElementById('deadline-input').value;
            if(newTime) {
                try {
                    await setDoc(doc(db, "config", "fruitSettings"), { gameDeadline: newTime }, { merge: true });
                    alert("é›²ç«¯æˆªæ­¢æ™‚é–“å·²åŒæ­¥ç‚º: " + newTime);
                } catch(e) { alert("åŒæ­¥å¤±æ•—: " + e); }
            }
        };

        window.addGameTime = async (minutes) => {
            if(!minutes || minutes <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åˆ†é˜æ•¸");
            const now = new Date();
            // Calculate target time with milliseconds precision, then format
            const targetTime = new Date(now.getTime() + minutes * 60 * 1000);
            
            const year = targetTime.getFullYear();
            const month = String(targetTime.getMonth() + 1).padStart(2, '0');
            const day = String(targetTime.getDate()).padStart(2, '0');
            const hours = String(targetTime.getHours()).padStart(2, '0');
            const min = String(targetTime.getMinutes()).padStart(2, '0');
            const sec = String(targetTime.getSeconds()).padStart(2, '0');
            
            // Include seconds in the ISO-like string
            const newTimeString = `${year}-${month}-${day}T${hours}:${min}:${sec}`;

            try {
                await setDoc(doc(db, "config", "fruitSettings"), { gameDeadline: newTimeString }, { merge: true });
                document.getElementById('deadline-input').value = newTimeString;
            } catch(e) { alert("è¨­å®šå¤±æ•—: " + e); }
        };

        window.uploadScore = async (uid, name, avatarUrl, score) => {
            if (window.gameStartTime > new Date(window.gameDeadline)) {
                alert("æŠ±æ­‰ï¼Œæ‚¨é–‹å§‹æŒ‘æˆ°æ™‚å·²è¶…éæ´»å‹•æˆªæ­¢æ™‚é–“ï¼Œåˆ†æ•¸å°‡ä¸åˆ—å…¥æ’è¡Œæ¦œã€‚");
                return;
            }
            try {
                await addDoc(collection(db, "scores"), {
                    userId: uid, 
                    playerName: name, 
                    avatar: avatarUrl, 
                    score: score, 
                    createdAt: serverTimestamp(),
                    playedAt: window.gameStartTime 
                });
            } catch (e) { console.error("Firebase Error: ", e); }
        };
        
        window.clearAllScores = async () => {
            if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ’è¡Œæ¦œæ•¸æ“šå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
            try {
                const q = query(collection(db, "scores"));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(doc => { batch.delete(doc.ref); });
                await batch.commit();
                alert("æ’è¡Œæ¦œå·²æˆåŠŸæ¸…ç©ºï¼");
            } catch(e) { alert("æ¸…ç©ºå¤±æ•—: " + e); }
        };

        window.updateLivesConfig = async () => {
            const val = parseInt(document.getElementById('lives-input').value);
            if(val < 3 || val > 7) return alert("è«‹è¼¸å…¥ 3 åˆ° 7 ä¹‹é–“çš„æ•¸å­—");
            try {
                await setDoc(doc(db, "config", "fruitSettings"), { maxLives: val }, { merge: true });
                alert("åˆå§‹ç”Ÿå‘½å€¼å·²æ›´æ–°ç‚º: " + val);
            } catch(e) { alert("è¨­å®šå¤±æ•—: " + e); }
        };

        window.updateTimeConfig = async () => {
            const val = parseInt(document.getElementById('time-input').value);
            if(val < 10 || val > 300) return alert("è«‹è¼¸å…¥ 10 åˆ° 300 ä¹‹é–“çš„æ•¸å­—");
            try {
                await setDoc(doc(db, "config", "fruitSettings"), { gameDuration: val }, { merge: true });
                alert("éŠæˆ²æ™‚é–“å·²æ›´æ–°ç‚º: " + val + " ç§’");
            } catch(e) { alert("è¨­å®šå¤±æ•—: " + e); }
        };

        // Admin Panel Toggle Logic
        window.toggleAdminSettings = () => {
            const panel = document.getElementById('admin-settings-panel');
            if (panel.classList.contains('translate-x-full')) {
                panel.classList.remove('translate-x-full');
            } else {
                panel.classList.add('translate-x-full');
            }
        };
        
        window.toggleAdminSidebar = () => {
            const sidebar = document.getElementById('admin-sidebar');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        };

        function startLeaderboardStream() {
            const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(60));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('admin-list');
                listEl.innerHTML = "";
                let rawData = [];
                snapshot.forEach(doc => { rawData.push(doc.data()); });
                const userBest = {};
                rawData.forEach(d => {
                    const uid = String(d.userId).trim();
                    if (!userBest[uid] || d.score > userBest[uid].score) userBest[uid] = d;
                });
                const sortedList = Object.values(userBest).sort((a,b) => b.score - a.score).slice(0, 10);
                sortedList.forEach((data, index) => {
                    let timeStr = "";
                    const ts = data.playedAt || data.createdAt;
                    if (ts && ts.toDate) {
                        const date = ts.toDate();
                        timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                    }
                    listEl.innerHTML += `
                        <div class="flex items-center justify-between bg-gray-800 p-4 rounded-xl border-l-4 ${index < 3 ? 'border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.3)]' : 'border-blue-500'}">
                            <div class="flex items-center space-x-4">
                                <span class="text-2xl font-black w-8 text-white">${index + 1}</span>
                                <img src="${data.avatar}" crossorigin="anonymous" class="w-12 h-12 rounded-full bg-gray-700">
                                <div><p class="font-bold text-xl text-white">${data.playerName}</p><p class="text-xs text-gray-400">ID: ${data.userId} <span class="text-gray-500 ml-2">(${timeStr})</span></p></div>
                            </div>
                            <span class="text-4xl font-black text-yellow-400">${data.score}</span>
                        </div>`;
                });
            });
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Microsoft JhengHei', sans-serif; }
        canvas { display: block; touch-action: none; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .overlay-content { min-height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 10px; }
        .avatar-option { width: 65px; height: 65px; border: 3px solid transparent; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; background: #333; overflow: hidden; }
        .avatar-option img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-selected { border-color: #fbbf24; transform: scale(1.1); box-shadow: 0 0 10px #fbbf24; }
        #screenshot-area { background: linear-gradient(145deg, #1e3a8a, #1e40af); padding: 30px; border-radius: 20px; text-align: center; color: white; border: 4px solid #fbbf24; width: 320px; }
        input { color: black; }
        #line-warning { position: fixed; top: 0; left: 0; width: 100%; background: #fbbf24; color: #000; padding: 10px; text-align: center; z-index: 9999; font-weight: bold; }
		/* Admin Button - Circular Fix */
        .admin-btn { position: fixed; top: 20px; right: 20px; z-index: 200; background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px; border-radius: 50%; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .admin-btn:hover { background: rgba(255, 255, 255, 0.4); }

        /* Sidebar Toggle Button */
        .admin-sidebar-btn { position: fixed; top: 20px; left: 20px; z-index: 200; background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px; border-radius: 50%; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; color: white; transition: background 0.2s; }
        .admin-sidebar-btn:hover { background: rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body>
    <div id="line-warning" class="hidden">è«‹é»æ“Šé¸å–® (å³ä¸‹è§’) â” é¸æ“‡ã€Œåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿã€ä»¥ç²å¾—æœ€ä½³é«”é©—</div>
    
    <div id="login-menu" class="overlay text-white">
        <a href="index.html" class="absolute top-6 left-6 bg-gray-700/50 hover:bg-gray-600 p-3 rounded-full text-white transition z-50">
            <span class="text-xl">ğŸ </span>
        </a>
        <div class="overlay-content">
            <img src="assets/logo-n.svg" alt="Meiloon Logo" class="h-16 mb-6 drop-shadow-lg">
			<div class="flex items-center justify-center space-x-2 mb-6">
				<h1 class="text-xl font-black text-yellow-400 italic leading-tight">2026 Meiloon - åˆ‡æ°´æœå¤§è³½</h1>
				<button onclick="document.getElementById('help-modal').classList.remove('hidden')" class="bg-gray-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold border border-gray-500 hover:bg-gray-600">?</button>
			</div>
            <div class="w-full max-w-sm space-y-4 text-black">
                <div class="flex space-x-2">
                    <input type="text" id="userId" placeholder="å·¥è™Ÿ" class="flex-1 p-3 rounded-lg text-center font-bold text-sm min-w-0">
                    <input type="text" id="pName" placeholder="æš±ç¨±" class="flex-1 p-3 rounded-lg text-center font-bold text-sm min-w-0">
                </div>
                <p class="text-gray-400 text-sm text-center pt-2">é¸æ“‡é ­åƒ</p>
                <div class="grid grid-cols-4 gap-3 py-2 justify-items-center" id="avatar-container"></div>
            </div>
            <button onclick="bootGame()" class="mt-8 bg-gradient-to-r from-yellow-600 to-orange-600 px-16 py-4 rounded-full text-xl font-bold shadow-xl active:scale-95 transition">é–‹å§‹æŒ‘æˆ°</button>
            <div class="mt-12 text-center text-gray-500 text-xs space-y-1">
                <p>Â© 2026 Meiloon All rights reserved.</p>
                <p>Developed by MarsLin</p>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="overlay text-white hidden flex items-center justify-center" style="z-index: 9999;" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-gray-900 p-6 rounded-2xl border border-gray-600 shadow-2xl max-w-2xl w-full min-h-[75vh] relative m-4">
            <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-white font-bold text-xl">âœ•</button>
            <h2 class="text-2xl md:text-4xl lg:text-5xl font-black mb-6 text-yellow-500 text-center tracking-widest">ğŸ éŠæˆ²èªªæ˜ ğŸ</h2>
            <div class="space-y-6 text-base md:text-xl lg:text-3xl text-gray-200 text-left leading-relaxed">
                <p>ğŸ”ª <span class="text-white font-bold">ç©æ³•ï¼š</span>æ»‘å‹•æ‰‹æŒ‡åˆ‡é–‹æ°´æœå¾—åˆ†ï¼Œä½†åƒè¬åˆ¥ç¢°åˆ°é»‘è‰²ç‚¸å½ˆï¼Œåˆ‡åˆ°ç‚¸å½ˆæœƒæ‰£ç”Ÿå‘½ï¼</p>
                <p>âŒ› <span class="text-white font-bold">çµæŸæ¢ä»¶ï¼š</span>ç•¶å³ä¸Šè§’<span class="text-red-500 font-bold">ç”Ÿå‘½å€¼æ­¸é›¶</span>æˆ–<span class="text-yellow-500 font-bold">å€’æ•¸æ™‚é–“çµæŸ</span>ï¼ŒéŠæˆ²å³åˆ»æˆªæ­¢ã€‚</p>                
                <p><span class="text-white font-bold">å…¶ä»–èªªæ˜ï¼š</span>æ°´æœå¾å·¦å³é‚Šé›¢é–‹å±å¹•ä¸æœƒæ‰£ç”Ÿå‘½å€¼ï¼Œ200åˆ†é–‹å§‹æœƒå‡ºç¾ç‚¸å½ˆå¹²æ“¾ã€‚</p>                
                <div class="border-t border-gray-700 pt-5 text-gray-400">
                    <p class="mb-3">â— åœ¨ä¸»æŒäººçµæŸæ´»å‹•å‰ï¼Œå¯é‡è¤‡æŒ‘æˆ°çˆ­å¥ªæœ€é«˜åˆ†ã€‚</p>
                    <p>â— çµæŸå¾Œè«‹é»æ“Š<span class="text-green-500 font-bold">ã€Œç”¢ç”Ÿæˆç¸¾å–®ã€</span>ä¸¦<span class="text-white font-bold">é•·æŒ‰åœ–ç‰‡å„²å­˜</span>ä½œç‚ºé ˜çæ†‘è­‰ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="overlay text-white hidden">
        <div class="bg-gray-900 p-8 rounded-2xl border border-gray-600 shadow-2xl text-center">
            <h2 class="text-xl font-bold mb-4 text-yellow-500">ç®¡ç†å“¡ç™»å…¥</h2>
            <input type="password" id="admin-pass-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="text-black p-2 rounded w-full mb-4 text-center">
            <button onclick="checkAdminLogin()" class="bg-blue-600 px-6 py-2 rounded-full font-bold w-full">ç™»å…¥</button>
        </div>
    </div>

    <!-- Fullscreen QR Overlay -->
    <div id="fullscreen-qr-overlay" class="overlay text-white hidden flex flex-col items-center justify-center" onclick="if(event.target === this) this.classList.add('hidden')" style="z-index: 9999;">
        <!-- Center QR Code -->
        <div class="bg-white p-6 rounded-2xl shadow-2xl transition-transform duration-100" id="qr-container">
            <div id="qrcode-full"></div>
        </div>
        
        <!-- Bottom Right Slider -->
        <div class="fixed bottom-10 right-10 w-64 bg-black/60 p-4 rounded-xl flex flex-col items-center space-y-2 backdrop-blur-md border border-white/10" onclick="event.stopPropagation()">
            <label class="text-sm font-bold text-yellow-400">ğŸ” èª¿æ•´å¤§å°</label>
            <input type="range" min="0.5" max="3.0" step="0.1" value="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-yellow-500" oninput="resizeQR(this.value)">
        </div>

        <!-- Bottom Left Text -->
        <div class="fixed bottom-10 left-10 text-left pointer-events-none">
            <p class="text-4xl font-black text-yellow-400 drop-shadow-lg mb-2">æƒæåŠ å…¥éŠæˆ²</p>
            <p class="text-lg text-gray-300">(é»æ“Šç©ºç™½è™•é—œé–‰)</p>
        </div>
    </div>

    <div id="admin-board" class="overlay text-white hidden">
		<!-- Settings Toggle Button -->
        <button onclick="toggleAdminSettings()" class="admin-btn text-2xl">âš™ï¸</button>
        <!-- Sidebar Toggle Button -->
        <button onclick="toggleAdminSidebar()" class="admin-sidebar-btn text-2xl">â˜°</button>

        <!-- Admin Sidebar -->
        <div id="admin-sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900/95 backdrop-blur-md border-r border-gray-700 shadow-2xl transform -translate-x-full transition-transform duration-300 z-[250] flex flex-col p-6 text-left">
            <h3 class="text-xl font-bold text-white mb-8 border-b border-gray-700 pb-4">å¿«é€Ÿåˆ‡æ›</h3>
            <a href="fruit-ninja.html?admin=true" class="text-gray-300 hover:text-yellow-400 py-3 font-bold flex items-center space-x-3"><span class="text-2xl">ğŸ</span> <span>åˆ‡æ°´æœ</span></a>
            <a href="whack-a-mole.html?admin=true" class="text-gray-300 hover:text-green-400 py-3 font-bold flex items-center space-x-3"><span class="text-2xl">ğŸ¹</span> <span>æ‰“åœ°é¼ </span></a>
            <a href="eating-contest.html?admin=true" class="text-gray-300 hover:text-purple-400 py-3 font-bold flex items-center space-x-3"><span class="text-2xl">ğŸ±</span> <span>å¤§èƒƒç‹</span></a>
            <button onclick="toggleAdminSidebar()" class="mt-auto text-gray-500 hover:text-white py-4 border-t border-gray-700">âœ– é—œé–‰é¸å–®</button>
        </div>
        
        <!-- Admin Settings Panel (Right Slide-in) -->
        <div id="admin-settings-panel" class="fixed top-0 right-0 h-full w-80 bg-gray-900/95 backdrop-blur-md border-l border-gray-700 shadow-2xl transform translate-x-full transition-transform duration-300 z-[250] flex flex-col p-6 overflow-y-auto">
             <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h3 class="text-yellow-500 font-bold text-lg">æ´»å‹•æ§åˆ¶å°</h3>
                <button onclick="toggleAdminSettings()" class="text-gray-400 hover:text-white font-bold text-xl">âœ•</button>
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-xs mb-2">æ´»å‹•æˆªæ­¢æ™‚é–“</label>
                <div class="flex space-x-2 mb-2">
                    <input type="datetime-local" id="deadline-input" step="1" class="text-black p-2 rounded flex-1 text-sm">
                    <button onclick="changeDeadline()" class="bg-blue-600 px-3 py-2 rounded text-sm font-bold">åŒæ­¥</button>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="addGameTime(5)" class="bg-gray-700 hover:bg-green-600 px-2 py-2 rounded text-xs font-bold transition">+5 åˆ†</button>
                    <button onclick="addGameTime(10)" class="bg-gray-700 hover:bg-green-600 px-2 py-2 rounded text-xs font-bold transition">+10 åˆ†</button>
                    <div class="flex space-x-1">
                        <input type="number" id="custom-min" placeholder="åˆ†" class="w-full text-black px-1 rounded text-center font-bold text-xs">
                        <button onclick="addGameTime(Number(document.getElementById('custom-min').value))" class="bg-blue-600 px-2 rounded text-xs font-bold">Go</button>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-xs mb-2">åˆå§‹ç”Ÿå‘½ (3-7)</label>
                <div class="flex space-x-2">
                    <input type="number" id="lives-input" min="3" max="7" placeholder="3" class="text-black p-2 rounded w-20 text-center font-bold">
                    <button onclick="updateLivesConfig()" class="bg-green-600 px-3 py-2 rounded text-sm font-bold flex-1">åŒæ­¥ç”Ÿå‘½å€¼</button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-xs mb-2">éŠæˆ²æ™‚é–“ (ç§’)</label>
                <div class="flex space-x-2">
                    <input type="number" id="time-input" min="10" max="300" placeholder="60" class="text-black p-2 rounded w-20 text-center font-bold">
                    <button onclick="updateTimeConfig()" class="bg-yellow-600 px-3 py-2 rounded text-sm font-bold flex-1">åŒæ­¥éŠæˆ²æ™‚é–“</button>
                </div>
            </div>

            <div class="mt-auto space-y-3 pt-6 border-t border-gray-700">
                <button onclick="document.getElementById('help-modal').classList.remove('hidden')" class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg w-full text-sm font-bold flex justify-center items-center space-x-2 transition border border-gray-600">
                    <span>ğŸ“– é¡¯ç¤ºéŠæˆ²èªªæ˜</span>
                </button>
                <button onclick="document.getElementById('fullscreen-qr-overlay').classList.remove('hidden')" class="bg-purple-600 hover:bg-purple-700 px-4 py-3 rounded-lg w-full text-sm font-bold flex justify-center items-center space-x-2 transition">
                    <span>ğŸ“± é¡¯ç¤ºæ´»å‹• QR Code</span>
                </button>
                <button onclick="clearAllScores()" class="bg-red-600 hover:bg-red-700 px-4 py-3 rounded-lg w-full text-sm font-bold flex justify-center items-center space-x-2 transition">
                    <span>âš  æ¸…ç©ºæ‰€æœ‰æ’è¡Œæ¦œæ•¸æ“š</span>
                </button>
            </div>
        </div>
        
        
        <div class="overlay-content pt-20">
            <div class="text-center mb-6 relative">
                <img src="assets/logo-n.svg" alt="Meiloon Logo" class="h-16 mx-auto mb-4 drop-shadow-lg">
                <div class="flex items-center justify-center space-x-4">
                    <h1 class="text-4xl font-black text-yellow-500 italic drop-shadow-lg">æ°´æœç‹ æ’è¡Œæ¦œ</h1>
                    <!-- Small QR Trigger -->
                    <div id="qrcode-small" class="bg-white p-1 cursor-pointer" onclick="document.getElementById('fullscreen-qr-overlay').classList.remove('hidden')"></div>
                </div>
            </div>
            
            <p class="mb-6 text-sm bg-black/50 px-3 py-1 rounded-full border border-yellow-500/30">æˆªæ­¢æ™‚é–“ï¼š<span id="current-deadline-text" class="text-yellow-400 font-bold">--</span></p>
            <div id="admin-list" class="w-full max-w-2xl space-y-3 pb-20"></div>

            <div class="mt-10 text-center text-gray-500 text-xs space-y-1 pb-4">
                <p>Â© 2026 Meiloon All rights reserved.</p>
                <p>Developed by MarsLin</p>
            </div>
        </div>
    </div>

    <div id="result-screen" class="overlay text-white hidden">
        <div class="overlay-content">
            <div id="final-image-container" class="hidden flex flex-col items-center">
                <img id="generated-image" class="rounded-xl shadow-2xl mb-4 border border-gray-500" style="max-height: 60vh;">
                <p class="text-yellow-400 font-bold text-lg animate-pulse mb-1">â¬† å¯é•·æŒ‰åœ–ç‰‡å„²å­˜ (å„²å­˜åˆ°ç…§ç‰‡) â¬†</p>
                <p class="text-gray-400 text-sm mb-4 text-center">âœ¨ æ­¤åœ–ç‰‡ç‚ºé ˜çæ†‘è­‰ï¼Œè«‹å¦¥å–„ä¿å­˜ âœ¨</p>
                <button onclick="location.reload()" class="bg-gray-700 px-6 py-2 rounded-full">è¿”å›ä¸»é </button>
            </div>
            <div id="screenshot-area">
                <p class="text-xs font-bold tracking-widest opacity-80 mb-2">2026 Meiloon - æ¥µé€Ÿåˆ‡æ°´æœ</p>
                <img id="res-avatar" src="" crossorigin="anonymous" class="w-24 h-24 rounded-full mx-auto mb-2 border-4 border-white bg-gray-800">
                <h2 id="res-name" class="text-2xl font-bold">æš±ç¨±</h2>
                <p id="res-uid" class="text-sm text-yellow-200 font-mono mb-2">ID: --</p>
                <div class="my-6">
                    <p class="text-sm opacity-70">SCORE</p>
                    <p id="res-score" class="text-7xl font-black text-yellow-400">0</p>
                </div>
                <p id="res-time" class="text-xs opacity-50"></p>
            </div>
            <div id="result-buttons" class="mt-6 flex flex-col items-center space-y-3">
                <button onclick="generateAndShowImage()" class="bg-green-600 hover:bg-green-500 px-10 py-3 rounded-lg font-bold flex items-center space-x-2 shadow-lg transition transform active:scale-95"><span>ğŸ“¸ ç”¢ç”Ÿæˆç¸¾å–®</span></button>
<!--                 <button onclick="location.reload()" class="text-gray-400 underline">å›ä¸»é¸å–®</button> -->
            </div>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdown-overlay" class="overlay text-white hidden flex items-center justify-center pointer-events-none" style="background: rgba(0,0,0,0.7); z-index: 200;">
        <div id="countdown-number" class="text-9xl font-black text-yellow-400 animate-ping">3</div>
    </div>

    <div id="ui">
        <div class="p-4 text-white text-2xl font-bold flex justify-between">
            <div id="liveScore">åˆ†æ•¸: 0</div>
            <div id="liveTime" class="text-yellow-400 font-mono">60s</div>
            <div id="liveLife" class="text-red-500">â¤â¤â¤</div>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let fruits = [], trail = [];
        let score = 0, lives = 3, timeLeft = 60, gameActive = false;
        let playerName = "", userId = "";
        let gameTimer; // Added timer variable
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSliceSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const startFreq = 600 + Math.random() * 400;
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(startFreq, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }
        function playBombSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        const avatars = [
            "assets/male1.png", "assets/male2.png", "assets/male3.png", "assets/male4.png",
            "assets/female1.png", "assets/female2.png", "assets/female3.png", "assets/female4.png",
            "assets/animal1.png", "assets/animal2.png", "assets/animal3.png", "assets/animal4.png",
        ];
        let selectedAvatar = avatars[0]; 
        function initAvatars() {
            const container = document.getElementById('avatar-container');
            container.innerHTML = avatars.map((url, index) => `
                <div class="avatar-option ${index === 0 ? 'avatar-selected' : ''}" onclick="setAvatar('${url}', this)">
                    <img src="${url}" crossorigin="anonymous" alt="avatar">
                </div>
            `).join('');
        }
        window.setAvatar = (url, el) => {
            document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('avatar-selected'));
            el.classList.add('avatar-selected');
            selectedAvatar = url;
        };
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        const fruitTypes = [
            { emoji: 'ğŸ', color: '#ff4d4d' }, { emoji: 'ğŸŠ', color: '#ffa502' },
            { emoji: 'ğŸ‰', color: '#2ed573' }, { emoji: 'ğŸ', color: '#eccc68' }, { emoji: 'ğŸ¥', color: '#7bed9f' }
        ];

        class Fruit {
            constructor() {
                // æ°´å¹³ä½ç½®ï¼šå…¨è¢å¹•éš¨æ©Ÿ
                this.x = Math.random() * (canvas.width - 80) + 40;
                this.y = canvas.height + 50;
                this.type = fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
                
                // å„ªåŒ–ï¼šç›´ä¸Šç›´ä¸‹é‚è¼¯ (0 ~ 15åº¦)
                // 1. å®šç¾©å€åŸŸ (å·¦å´ 1/3, å³å´ 1/3, ä¸­é–“ 1/3)
                const leftZone = canvas.width * 0.33;
                const rightZone = canvas.width * 0.66;
                
                let angleDir = 0; // 0: å‚ç›´, 1: å¾€å³, -1: å¾€å·¦

                if (this.x < leftZone) {
                    // å·¦å´å€åŸŸï¼šåªèƒ½å¾€å³ (0 ~ 1.5)
                    angleDir = Math.random() * 1; 
                } else if (this.x > rightZone) {
                    // å³å´å€åŸŸï¼šåªèƒ½å¾€å·¦ (-1.5 ~ 0)
                    angleDir = -(Math.random() * 1);
                } else {
                    // ä¸­é–“å€åŸŸï¼šéš¨æ©Ÿå¾®å (-1.0 ~ 1.0)
                    angleDir = (Math.random() - 0.5) * 2;
                }

                this.vx = angleDir; 

                // --- ã€å¾®èª¿å€ï¼šé€Ÿåº¦è¨­å®šã€‘ ---
                this.vy = -(Math.random() * 4 + 9);  // ä¸Šæ‹‹é€Ÿåº¦
                this.gravity = 0.08;                 // é‡åŠ›
                // ---------------------------
                this.radius = 35; this.sliced = false; this.isBomb = false;
            }
            update() {
                this.vy += this.gravity; this.x += this.vx; this.y += this.vy;
                // ç§»é™¤æ’ç‰†åœæ­¢çš„é‚è¼¯ï¼Œè®“æ°´æœè‡ªç„¶æ‹‹ç‰©ç·šé£›è¡Œ
            }
            draw() { ctx.font = "50px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(this.type.emoji, this.x, this.y); }
        }
        class Bomb extends Fruit {
            constructor() { super(); this.type = { emoji: 'ğŸ’£', color: '#000' }; this.radius = 40; this.isBomb = true; }
        }

        window.bootGame = () => {
            userId = document.getElementById('userId').value;
            playerName = document.getElementById('pName').value;
            if(!userId || !playerName) return alert("è«‹å¡«å¯«å·¥è™Ÿèˆ‡æš±ç¨±");
            localStorage.setItem('meiloon_userid', userId);
            localStorage.setItem('meiloon_pname', playerName);

            window.gameStartTime = new Date();
            const deadlineStr = localStorage.getItem('gameDeadline');
            if (deadlineStr && new Date() > new Date(deadlineStr)) {
                alert("æé†’ï¼šæ´»å‹•æ™‚é–“å·²æˆªæ­¢ï¼Œæœ¬æ¬¡éŠç©åˆ†æ•¸å¯èƒ½ä¸æœƒåˆ—å…¥æ’è¡Œæ¦œè¨ˆç®—ã€‚");
            }

            document.getElementById('login-menu').style.display = 'none';
            lives = (window.maxLives !== undefined) ? window.maxLives : 5;
            timeLeft = (window.gameDuration !== undefined) ? window.gameDuration : 45;
            score = 0; fruits = []; 
            updateUI();

            // --- 3ç§’å€’æ•¸æ©Ÿåˆ¶ ---
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('countdown-number');
            overlay.classList.remove('hidden');
            let count = 3;
            numEl.innerText = count;

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    numEl.innerText = count;
                } else if(count === 0) {
                    numEl.innerText = "GO!";
                } else {
                    clearInterval(timer);
                    overlay.classList.add('hidden');
                    gameActive = true; 
                    loop();
                    // Start Game Timer
                    if(gameTimer) clearInterval(gameTimer);
                    gameTimer = setInterval(() => {
                        if(gameActive) {
                            timeLeft--;
                            updateUI();
                            if(timeLeft <= 0) {
                                clearInterval(gameTimer);
                                endGame();
                            }
                        }
                    }, 1000);
                }
            }, 1000);
        }
        
        function updateUI() {
            document.getElementById('liveScore').innerText = `åˆ†æ•¸: ${score}`;
            document.getElementById('liveLife').innerText = "â¤".repeat(Math.max(0, lives));
            document.getElementById('liveTime').innerText = `${timeLeft}s`;
            if(timeLeft <= 10) document.getElementById('liveTime').classList.add('text-red-500');
            else document.getElementById('liveTime').classList.remove('text-red-500');
        }
        function handleMove(e) {
            if (!gameActive) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            trail.push({x, y, age: 0});
            fruits.forEach((f) => {
                if (!f.sliced && Math.hypot(f.x - x, f.y - y) < f.radius) {
                    f.sliced = true;
                    if (f.isBomb) {
                        if(navigator.vibrate) navigator.vibrate(200); // ç‚¸å½ˆé•·éœ‡å‹•
                        lives--; playBombSound();
                        document.body.style.backgroundColor = 'red';
                        setTimeout(() => document.body.style.backgroundColor = '#1a1a1a', 100);
                    } else { 
                        if(navigator.vibrate) navigator.vibrate(30); // åˆ‡æ°´æœè¼•éœ‡å‹•
                        score += 10; playSliceSound(); 
                    }
                    updateUI();
                }
            });
        }
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, {passive: false});

        let lastFrameTime = 0;
        const frameInterval = 1000 / 60; // å¼·åˆ¶é–å®š 60 FPS

        function loop(timestamp) {
            if (!gameActive) return;

            // ç¢ºä¿ timestamp æœ‰å€¼ (ç¬¬ä¸€æ¬¡åŸ·è¡Œå¯èƒ½ç‚º undefined)
            if (!timestamp) timestamp = performance.now();

            // è¨ˆç®—è·é›¢ä¸Šä¸€å¹€ç¶“éäº†å¤šä¹…
            const elapsed = timestamp - lastFrameTime;

            // å¦‚æœç¶“éçš„æ™‚é–“é‚„ä¸åˆ° 16.6ms (60fps)ï¼Œå°±è·³éé€™ä¸€å¹€ä¸åŸ·è¡Œé‹ç®—
            if (elapsed < frameInterval) {
                requestAnimationFrame(loop);
                return;
            }

            // æ ¡æ­£æ™‚é–“å·®ï¼Œç¢ºä¿é•·æ™‚é–“é‹è¡Œä¸é£„ç§»
            lastFrameTime = timestamp - (elapsed % frameInterval);

            // --- éŠæˆ²é‚è¼¯é–‹å§‹ ---
            ctx.fillStyle = 'rgba(26, 26, 26, 0.7)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 4; ctx.beginPath();
            for(let i=0; i<trail.length; i++) {
                if(i==0) ctx.moveTo(trail[i].x, trail[i].y); else ctx.lineTo(trail[i].x, trail[i].y);
                trail[i].age++;
            }
            ctx.stroke(); trail = trail.filter(t => t.age < 10);
            
            // å„ªåŒ–ï¼šå‹•æ…‹é™åˆ¶æ•¸é‡ (åˆ†æ•¸ < 200 æ™‚æœ€å¤š 5 é¡†ï¼Œç‚¸å½ˆå‡ºç¾å¾Œæ”¾å¯¬è‡³ 8 é¡†)
            const maxFruits = score >= 200 ? 7 : 5;
            if (fruits.length < maxFruits && Math.random() < 0.05) {
                if (score >= 200 && Math.random() < 0.2) fruits.push(new Bomb());
                else fruits.push(new Fruit());
            }
            for (let i = fruits.length - 1; i >= 0; i--) {
                fruits[i].update(); fruits[i].draw();
                
                // æª¢æŸ¥æ˜¯å¦æ‰è½åˆ°è¢å¹•åº•éƒ¨
                if (fruits[i].y > canvas.height + 100) {
                    // åªæœ‰ã€Œæ²’è¢«åˆ‡éã€ä¸”ã€Œä¸æ˜¯ç‚¸å½ˆã€æ‰éœ€è¦åˆ¤æ–·æ˜¯å¦æ‰£å‘½
                    if (!fruits[i].sliced && !fruits[i].isBomb) { 
                        // ä¿®æ­£ï¼šåªæœ‰åœ¨ã€Œæ°´å¹³å¯è¦–ç¯„åœé™„è¿‘ã€æ‰è½çš„æ‰ç®—æ¼æ¥æ‰£å‘½
                        // å¦‚æœé£›å¾—å¤ªé (åˆ‡ä¸åˆ°)ï¼Œå°±ä¸æ‰£åˆ†ç•¶ä½œæ²’äº‹ç™¼ç”Ÿ
                        if (fruits[i].x > -50 && fruits[i].x < canvas.width + 50) {
                            lives--; updateUI(); 
                        }
                    }
                    fruits.splice(i, 1);
                } else if (fruits[i].sliced) { 
                    fruits.splice(i, 1); 
                }
            }
            
            if (lives <= 0) endGame(); 
            else requestAnimationFrame(loop);
        }
        async function endGame() {
            gameActive = false;
            if(gameTimer) clearInterval(gameTimer);
            document.getElementById('res-avatar').src = selectedAvatar;
            document.getElementById('res-name').innerText = playerName;
            document.getElementById('res-uid').innerText = "ID: " + userId;
            document.getElementById('res-score').innerText = score;
            document.getElementById('res-time').innerText = "DATE: " + new Date().toLocaleString();
            document.getElementById('result-screen').classList.remove('hidden');
            if (window.uploadScore) await window.uploadScore(userId, playerName, selectedAvatar, score);
        }
        window.generateAndShowImage = () => {
            const target = document.querySelector("#screenshot-area");
            target.style.transform = "scale(1)"; 
            html2canvas(target, { useCORS: true, backgroundColor: null, scale: 2 }).then(c => {
                const imgData = c.toDataURL("image/png");
                document.getElementById('screenshot-area').classList.add('hidden');
                document.getElementById('result-buttons').classList.add('hidden');
                const imgEl = document.getElementById('generated-image');
                imgEl.src = imgData;
                document.getElementById('final-image-container').classList.remove('hidden');
            });
        };
    </script>
</body>
</html>